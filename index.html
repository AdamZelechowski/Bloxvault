<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BloxVault</title>

  <!-- Bootstrap CSS & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

  <style>
    body { background-color: #ff7700; font-family: 'Segoe UI', sans-serif; margin: 0; }
    .navbar { background-color: #2c2c2c; }
    .navbar-brand { color: #fff !important; font-weight: bold; display: flex; align-items: center; }
    .navbar-brand img { height: 32px; margin-right: 10px; }
    .nav-link, .btn-link { color: #fff !important; font-weight: bold; }
    #gemCounter { color: #ffbb33; font-weight: bold; font-size: 1.1rem; display: flex; align-items: center; gap: 6px; user-select: none; }
    #gemCounter i { color: #ffbb33; font-size: 1.3rem; }
    @keyframes rgbChroma { 0% { background-color: #ff0000; } 25% { background-color: #00ff00; } 50% { background-color: #0000ff; } 75% { background-color: #ffff00; } 100% { background-color: #ff0000; } }
    .rgb-chroma { animation: rgbChroma 4s linear infinite; color: white !important; font-weight: bold; border: none; }
    #adminPanelDropdown .dropdown-menu { background-color: #222 !important; border: 1px solid #fff !important; min-width: 200px; }
    #adminPanelDropdown .dropdown-item { color: #fff !important; cursor: pointer; }
    #adminPanelDropdown .dropdown-item:hover { background-color: #ff7700 !important; color: #000 !important; }

    /* Dashboard cards */
    .dashboard-card {
      background-color: #2c2c2c;
      color: #fff;
      border: 2px solid #ffbb33;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
    }
    .dashboard-card h4 {
      color: #ffbb33;
      font-weight: bold;
    }
    /* Offerwall */
    #offerwallFrame { width: 100%; height: 100%; border: none; }

    /* Landing/Login/Signup container styling */
    #authContainer {
      background: #2c2c2c;
      color: white;
      max-width: 400px;
      margin: 80px auto;
      padding: 30px 25px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      display: none;
      text-align: center;
      font-family: 'Segoe UI', sans-serif;
    }
    #authContainer h1 {
      color: #ffbb33;
      margin-bottom: 15px;
      font-weight: bold;
    }
    #authContainer p {
      color: #ddd;
      font-size: 0.9rem;
      margin-bottom: 20px;
    }
    #authContainer input[type="email"],
    #authContainer input[type="text"],
    #authContainer input[type="password"] {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border-radius: 6px;
      border: none;
    }
    #authContainer .btn {
      width: 100%;
      padding: 12px;
      margin-top: 12px;
      background: #ffbb33;
      border: none;
      border-radius: 8px;
      color: #2c2c2c;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    #authContainer .btn:hover {
      background: #e6a600;
    }
    #authContainer .btn.google-btn {
      background: #fff;
      color: #2c2c2c;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
    }
    #authContainer .btn.google-btn img {
      height: 18px;
    }
    #authContainer .hidden {
      display: none;
    }
    #authContainer .tos-box {
      background: #1a1a1a;
      color: #ccc;
      font-size: 0.8rem;
      padding: 10px;
      margin: 12px 0 6px;
      height: 90px;
      overflow-y: auto;
      border-radius: 6px;
      border: 1px solid #555;
      text-align: left;
    }
    #authContainer label {
      display: block;
      margin-bottom: 12px;
      user-select: none;
    }
    #authContainer label input[type="checkbox"] {
      margin-right: 6px;
    }

  </style>
</head>
<body>

  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg px-3" id="topNavbar" style="display:none;">
    <a class="navbar-brand" href="#">
      <img src="https://raw.githubusercontent.com/AdamZelechowski/Bloxvault/main/BloxVault.png" alt="Logo" />
      BloxVault
    </a>
    <div class="d-flex ms-auto gap-3 align-items-center" id="navButtons">
      <button class="btn btn-link nav-link" onclick="showDashboard()"><i class="bi bi-house-door-fill"></i> Home</button>
      <button class="btn btn-link nav-link" onclick="showRedeem()"><i class="bi bi-gift-fill"></i> Redeem</button>
      <button class="btn btn-link nav-link" onclick="showEarn()"><i class="bi bi-cash-coin"></i> Earn</button>
      <div id="gemCounter" title="Your Gems"><i class="bi bi-gem"></i> <span id="gemsCount">0</span></div>
      <div class="dropdown" id="adminPanelDropdown" style="display: none;">
        <button class="btn dropdown-toggle rgb-chroma" type="button" data-bs-toggle="dropdown">Admin Panel</button>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" href="#" onclick="viewUsers()">View Users</a></li>
          <li><a class="dropdown-item" href="#" onclick="viewRewardRequests()">Reward Requests</a></li>
          <li><a class="dropdown-item" href="#" onclick="runDiagnostics()">Run Diagnostics</a></li>
          <li><a class="dropdown-item" href="#" onclick="adminLookupUser()">User Lookup</a></li>
        </ul>
      </div>
      <button class="btn btn-link nav-link" onclick="logout()"><i class="bi bi-box-arrow-right"></i> Logout</button>
    </div>
  </nav>

  <!-- AUTH / LANDING CONTAINER -->
  <div id="authContainer">
    <!-- Landing Page -->
    <div id="landing">
      <h1>Welcome to BloxVault</h1>
      <p>Earn gems by completing offers, then redeem for Robux, crypto, and more. Safe, easy, and free!</p>
      <button class="btn" onclick="showLogin()">Login</button>
      <button class="btn" onclick="showSignup()">Sign Up</button>
    </div>

    <!-- Login Form -->
    <div id="loginForm" class="hidden">
      <h1>Login</h1>
      <input type="email" id="loginEmail" placeholder="Email" autocomplete="username" />
      <input type="password" id="loginPassword" placeholder="Password" autocomplete="current-password" />
      <button class="btn" onclick="login()">Login</button>
      <button class="btn google-btn" onclick="googleLogin()">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google Logo" />
        Sign in with Google
      </button>
      <button class="btn" style="background:#555; color:#fff;" onclick="showLanding()">Back</button>
    </div>

    <!-- Signup Form -->
    <div id="signupForm" class="hidden">
      <h1>Sign Up</h1>
      <input type="email" id="signupEmail" placeholder="Email" autocomplete="email" />
      <input type="text" id="signupUsername" placeholder="Username" autocomplete="username" />
      <input type="password" id="signupPassword" placeholder="Password" autocomplete="new-password" />
      <div class="tos-box" tabindex="0" role="region" aria-label="Terms of Service">
        <strong>Terms of Service:</strong><br>
        By creating an account, you agree not to misuse this platform, attempt fraudulent activity,
        or violate any applicable laws. You must be 13+ to participate. Abuse will lead to bans.
      </div>
      <label>
        <input type="checkbox" id="acceptTOS" />
        I accept the Terms of Service
      </label>
      <button class="btn" onclick="signup()">Create Account</button>
      <button class="btn" style="background:#555; color:#fff;" onclick="showLanding()">Back</button>
    </div>
  </div>

  <!-- MAIN CONTAINER -->
  <div class="container py-5" id="mainContainer" style="display:none;">
    <!-- DASHBOARD -->
    <div id="dashboard" style="display:none;">
      <h1 class="text-center mb-4" style="color:#fff;">Welcome to your Dashboard!</h1>
      <div class="row g-4">
        <div class="col-md-4">
          <div class="dashboard-card">
            <h4><i class="bi bi-gem"></i> Your Gems</h4>
            <p id="dashboardGems">Loading...</p>
          </div>
        </div>
        <div class="col-md-4">
          <div class="dashboard-card">
            <h4><i class="bi bi-graph-up"></i> Recent Activity</h4>
            <p>Track your latest earnings & redemptions.</p>
          </div>
        </div>
        <div class="col-md-4">
          <div class="dashboard-card">
            <h4><i class="bi bi-trophy"></i> Top Earners</h4>
            <p>See who's earning the most this week!</p>
          </div>
        </div>
      </div>
    </div>

    <!-- REDEEM PAGE -->
    <div id="redeem" style="display:none;">
      <div class="card p-4">
        <h2 class="text-center mb-4">üéÅ Redeem Your Gems</h2>
        <p class="text-center">Exchange your gems for Robux, crypto, and more!</p>
        <div class="mb-3">
          <label for="rewardType" class="form-label">Choose a Reward</label>
          <select id="rewardType" class="form-select">
            <option>Robux</option>
            <option>Crypto</option>
          </select>
        </div>
        <input id="rewardDetails" type="text" class="form-control mb-3" placeholder="Your username or wallet" />
        <button onclick="requestReward()" class="btn btn-primary w-100">Submit Request</button>
      </div>
    </div>

    <!-- EARN PAGE -->
    <div id="earn" style="display:none;">
      <div class="card p-4">
        <h2 class="text-center mb-4">üíé Earn Gems</h2>
        <p class="text-center">Complete surveys & offers to earn gems instantly!</p>
        <div style="width:100%; border:2px solid #ffbb33; border-radius:10px; overflow:hidden; display: flex; flex-direction: column; gap: 10px;">
          
          <!-- Torox -->
          <iframe 
            id="offerwallFrameTorox" 
            src="https://wall.torox.gg/your_torox_app_id?uid=USER_ID" 
            style="height:190px; width:100%; border:none; border-radius: 8px;">
          </iframe>

          <!-- CPX Research -->
          <iframe 
            id="offerwallFrameCPX" 
            src="https://offers.cpx-research.com/index.php?app_id=YOUR_APP_ID&ext_user_id=USER_ID" 
            style="height:190px; width:100%; border:none; border-radius: 8px;">
          </iframe>

          <!-- AdGem -->
          <iframe 
            id="offerwallFrameAdGem" 
            src="https://api.adgem.com/v1/wall?appid=YOUR_APP_ID&playerid=USER_ID" 
            style="height:190px; width:100%; border:none; border-radius: 8px;">
          </iframe>

        </div>
      </div>
    </div>
  </div>

  <!-- FIREBASE + LOGIC -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendEmailVerification, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBDuLLrHkMp8J3iyb183lDzSrNNIPallcQ",
      authDomain: "bloxvault-d1ff0.firebaseapp.com",
      projectId: "bloxvault-d1ff0",
      storageBucket: "bloxvault-d1ff0.appspot.com",
      messagingSenderId: "365008891027",
      appId: "1:365008891027:web:3578577b3c33714f207166"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI Functions for auth container (landing/login/signup)
    const showLogin = () => {
      document.getElementById("landing").classList.add("hidden");
      document.getElementById("signupForm").classList.add("hidden");
      document.getElementById("loginForm").classList.remove("hidden");
      document.getElementById("authContainer").style.display = "block";
      document.getElementById("mainContainer").style.display = "none";
      document.getElementById("topNavbar").style.display = "none";
    };
    const showSignup = () => {
      document.getElementById("landing").classList.add("hidden");
      document.getElementById("loginForm").classList.add("hidden");
      document.getElementById("signupForm").classList.remove("hidden");
      document.getElementById("authContainer").style.display = "block";
      document.getElementById("mainContainer").style.display = "none";
      document.getElementById("topNavbar").style.display = "none";
    };
    const showLanding = () => {
      document.getElementById("loginForm").classList.add("hidden");
      document.getElementById("signupForm").classList.add("hidden");
      document.getElementById("landing").classList.remove("hidden");
      document.getElementById("authContainer").style.display = "block";
      document.getElementById("mainContainer").style.display = "none";
      document.getElementById("topNavbar").style.display = "none";
    };
    const showDashboard = () => {
      document.getElementById("authContainer").style.display = "none";
      document.getElementById("mainContainer").style.display = "block";
      document.getElementById("dashboard").style.display = "block";
      document.getElementById("redeem").style.display = "none";
      document.getElementById("earn").style.display = "none";
      document.getElementById("topNavbar").style.display = "flex";
    };
    const showRedeem = () => {
      document.getElementById("dashboard").style.display = "none";
      document.getElementById("redeem").style.display = "block";
      document.getElementById("earn").style.display = "none";
    };
    const showEarn = () => {
      document.getElementById("dashboard").style.display = "none";
      document.getElementById("redeem").style.display = "none";
      document.getElementById("earn").style.display = "block";
    };

    // Listen for auth state changes
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        if (!user.emailVerified && !user.providerData.some(p => p.providerId === "google.com")) {
          alert("Please verify your email before logging in.");
          signOut(auth);
          showLanding();
          return;
        }
        document.getElementById("gemCounter").textContent = "Loading...";
        document.getElementById("gemCounter").innerHTML = '<i class="bi bi-gem"></i> Loading...';
        try {
          const userDoc = await getDoc(doc(db, "users", user.uid));
          const points = userDoc.exists() ? (userDoc.data().points || 0) : 0;
          document.getElementById("gemsCount").textContent = points;
          document.getElementById("dashboardGems").textContent = points + " Gems";
        } catch {
          document.getElementById("gemsCount").textContent = "0";
          document.getElementById("dashboardGems").textContent = "0 Gems";
        }
        // Show/hide admin panel for owner
        document.getElementById("adminPanelDropdown").style.display = user.email === "youradmin@example.com" ? "block" : "none";

        showDashboard();
      } else {
        document.getElementById("gemCounter").textContent = "";
        showLanding();
      }
    });

    // Login function
    window.login = () => {
      const email = document.getElementById("loginEmail").value.trim();
      const pass = document.getElementById("loginPassword").value;
      if (!email || !pass) return alert("Please enter both email and password.");
      signInWithEmailAndPassword(auth, email, pass)
        .then((userCred) => {
          if (!userCred.user.emailVerified && !userCred.user.providerData.some(p => p.providerId === "google.com")) {
            alert("Please verify your email before logging in.");
            signOut(auth);
            return;
          }
          showDashboard();
        })
        .catch((err) => alert(err.message));
    };

    // Signup function
    window.signup = () => {
      const email = document.getElementById("signupEmail").value.trim();
      const pass = document.getElementById("signupPassword").value;
      const tos = document.getElementById("acceptTOS").checked;
      if (!email || !pass) return alert("Please enter both email and password.");
      if (!tos) return alert("You must accept the Terms of Service.");
      createUserWithEmailAndPassword(auth, email, pass)
        .then((userCred) => {
          sendEmailVerification(userCred.user);
          alert("Account created! Please verify your email before logging in.");
          showLogin();
        })
        .catch((err) => alert(err.message));
    };

    // Google login
    window.googleLogin = () => {
      const provider = new GoogleAuthProvider();
      signInWithPopup(auth, provider)
        .then(() => {
          showDashboard();
        })
        .catch((err) => alert(err.message));
    };

    // Logout
    window.logout = () => {
      signOut(auth).then(() => {
        showLanding();
      });
    };

    // Navigation bindings for nav buttons (you can extend as needed)
    window.showDashboard = showDashboard;
    window.showRedeem = showRedeem;
    window.showEarn = showEarn;
    window.showLogin = showLogin;
    window.showSignup = showSignup;
    window.showLanding = showLanding;

    // Placeholder functions for admin panel items
    window.viewUsers = () => alert("View users - Admin only.");
    window.viewRewardRequests = () => alert("View reward requests - Admin only.");
    window.runDiagnostics = () => alert("Run diagnostics - Admin only.");
    window.adminLookupUser = () => alert("User lookup - Admin only.");

    // Placeholder for redeem request
    window.requestReward = () => alert("Reward request submitted! (Not yet implemented)");

  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
